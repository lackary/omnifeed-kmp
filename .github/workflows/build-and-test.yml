name: Build and Test

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'sample/**'
      - 'core/**'
      - 'ui/**'
      - 'integrations/**'
      - 'gradle/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'package.json'

  pull_request:
    branches:
      - '*'
    paths:
      - '.github/workflows/**'
      - 'sample/**'
      - 'core/**'
      - 'ui/**'
      - 'integrations/**'
      - 'gradle/**'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - 'package.json'

  workflow_dispatch:
    inputs:
      enable_kotlin_daemon:
        description: 'Enable Kotlin/Native Daemon for build'
        type: boolean
        required: false
        default: false
      run_with_stacktrace:
        description: 'Run Gradle with --stacktrace'
        type: boolean
        required: false
        default: false
      run_with_info:
        description: 'Run Gradle with --info'
        type: boolean
        required: false
        default: false
      run_with_debug:
        description: 'Run Gradle with --debug'
        type: boolean
        required: false
        default: false

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    env:
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      UNSPLASH_SECRET_KEY: ${{ secrets.UNSPLASH_SECRET_KEY }}
      GOOGLE_SERVICES_WEB_CLIENT_ID: ${{ secrets.GOOGLE_SERVICES_WEB_CLIENT_ID }}
    permissions:
      contents: read
      checks: write # For mikepenz/action-junit-report
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create Dynamic Secrets XConfig File
        working-directory: './sample/iosApp/Configuration'
        run: |
          XCONFIG_DEBUG_FILENAME="Secrets-Debug.xconfig"
          XCONFIG_RELEASE_FILENAME="Secrets-Release.xconfig"

          echo "Creating ${XCONFIG_DEBUG_FILENAME} in CI..."
          echo "Creating ${XCONFIG_RELEASE_FILENAME} in CI..."
          
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" > "${XCONFIG_DEBUG_FILENAME}"
          echo "REVERSED_CLIENT_ID=${{ secrets.GOOGLE_REVERSED_CLIENT_ID }}" >> "${XCONFIG_DEBUG_FILENAME}"
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" > "${XCONFIG_RELEASE_FILENAME}"
          echo "REVERSED_CLIENT_ID=${{ secrets.GOOGLE_REVERSED_CLIENT_ID }}" >> "${XCONFIG_RELEASE_FILENAME}"

      - name: Setup iOS Environment (Dummy Framework & Pods)
        run: |
          if [ -n "$ACT" ]; then
            echo "Running in 'act' environment."
            if ! command -v pod &> /dev/null; then
              echo "CocoaPods not found. Installing via Homebrew..."
              brew install cocoapods
            else
              echo "CocoaPods is already installed."
            fi
          else
            echo "Running in CI environment. Installing CocoaPods..."
            gem install cocoapods
          fi

          echo "Running Setup Script..."
          chmod +x setup_ios.sh
          ./setup_ios.sh

      # List simulators
      - name: List available simulators
        run: |
          echo "=== RUNTIMES ==="
          xcrun simctl list runtimes
          echo "=== DEVICES ==="
          xcrun simctl list devices

      # Automatically find an available simulator
      - name: Select an available simulator
        id: find-sim
        run: |
          set -e
          SIM=$(xcrun simctl list devices | \
            grep -E "iPhone" | \
            grep -v unavailable | \
            grep -v "(Booted)" | \
            sed -nE 's/.*\(([0-9A-F-]{36})\).*/\1/p' | \
            head -n 1)

          if [ -z "$SIM" ]; then
            echo "❌ No available iPhone simulators found"
            exit 1
          fi
          echo "✅ Selected Simulator UUID: $SIM"
          echo "SIM=$SIM" >> $GITHUB_ENV

      - name: Xcode Build (clean build .xcworkspace)
        working-directory: './sample/iosApp'
        run: |
          echo "Building iOS target via .xcworkspace..."
          xcodebuild clean build \
              -workspace "iosApp.xcworkspace" \
              -scheme "iosApp" \
              -configuration "Debug" \
              -sdk iphonesimulator \
              -destination "id=$SIM" \
              ENABLE_PREVIEWS=NO

      - name: Gradle Build to Generate KMP Framework
        run: |
          ./gradlew assemble \
              ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
              ${{ inputs.run_with_info && '--info' || '' }} \
              ${{ inputs.run_with_debug && '--debug' || '' }} \
              ${{ inputs.enable_kotlin_daemon && '-Pkotlin.native.enableDaemon=true' || '' }}

      - name: Run KMP Unit Tests
        run: |
          ./gradlew check \
              -Pskip.tests=false \
              -Pskip.native.tests=false \
              -Pskip.lint=true \
              ${{ inputs.run_with_stacktrace && '--stacktrace' || '' }} \
              ${{ inputs.run_with_info && '--info' || '' }} \
              ${{ inputs.run_with_debug && '--debug' || '' }} \
              ${{ inputs.enable_kotlin_daemon && '-Pkotlin.native.enableDaemon=true' || '' }}

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/**/*.xml'
          check_name: 'JUnit Test Report'
          detailed_summary: true
          include_passed: true
          annotate_only: ${{ env.ACT == 'true' }}

      - name: Upload Test Report HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-html
          path: '**/build/reports/tests/'
          retention-days: 5
